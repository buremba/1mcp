/**
 * AI SDK Tool Loader
 *
 * Dynamically loads AI SDK tools from configured file paths and converts them to MCP format.
 * Similar to MCP Manager but for local AI SDK tools.
 */

import { pathToFileURL } from "node:url";
import { resolve, basename } from "node:path";
import type { AiSdkToolConfig } from "@1mcp/shared";
import { aiSdkToolToMcp, executeAiSdkTool } from "@1mcp/ai-sdk";
import type { AiSdkTool, McpTool } from "@1mcp/ai-sdk";

interface LoadedTool {
	name: string;
	mcpTool: McpTool;
	aiSdkTool: AiSdkTool;
}

export class AiSdkToolLoader {
	private tools: Map<string, LoadedTool> = new Map();
	private projectRoot: string;

	constructor(projectRoot: string) {
		this.projectRoot = projectRoot;
	}

	/**
	 * Load AI SDK tools from configuration
	 */
	async loadTools(configs: AiSdkToolConfig[]): Promise<void> {
		console.log(
			`[AI SDK Loader] Loading ${configs.length} AI SDK tool(s)...`,
		);

		for (const config of configs) {
			try {
				await this.loadTool(config);
			} catch (error) {
				console.error(
					`[AI SDK Loader] Failed to load tool from ${config.path}:`,
					error,
				);
				// Continue loading other tools even if one fails
			}
		}

		console.log(
			`[AI SDK Loader] Successfully loaded ${this.tools.size} tool(s)`,
		);
	}

	/**
	 * Load a single AI SDK tool from a file
	 */
	private async loadTool(config: AiSdkToolConfig): Promise<void> {
		// Resolve path relative to project root
		const absolutePath = resolve(this.projectRoot, config.path);

		console.log(
			`[AI SDK Loader] Loading tool from: ${absolutePath}`,
		);

		// Dynamic import the tool module
		const fileUrl = pathToFileURL(absolutePath).href;
		const module = await import(fileUrl);

		// Determine which export to use
		let aiSdkTool: AiSdkTool;
		let toolName: string;

		if (config.export) {
			// Use specified export
			aiSdkTool = module[config.export] as AiSdkTool;
			toolName = config.name || config.export;

			if (!aiSdkTool) {
				throw new Error(
					`Export '${config.export}' not found in ${config.path}`,
				);
			}
		} else if (module.default) {
			// Use default export
			aiSdkTool = module.default as AiSdkTool;
			toolName =
				config.name || basename(config.path, ".ts").replace(/\.js$/, "");
		} else {
			// Try to find a single named export
			const exports = Object.keys(module).filter(
				(key) => key !== "default" && !key.startsWith("_"),
			);

			if (exports.length === 0) {
				throw new Error(
					`No exports found in ${config.path}. Make sure the file exports an AI SDK tool.`,
				);
			}

			if (exports.length > 1) {
				throw new Error(
					`Multiple exports found in ${config.path} (${exports.join(", ")}). Please specify which export to use with the 'export' field in config.`,
				);
			}

			const exportName = exports[0];
			if (!exportName) {
				throw new Error(`No valid export found in ${config.path}`);
			}
			aiSdkTool = module[exportName] as AiSdkTool;
			toolName = config.name || exportName;
		}

		// Validate that it's an AI SDK tool
		if (
			!aiSdkTool ||
			typeof aiSdkTool !== "object" ||
			!("parameters" in aiSdkTool) ||
			!("execute" in aiSdkTool)
		) {
			throw new Error(
				`Invalid AI SDK tool in ${config.path}. Expected an object with 'parameters' and 'execute' properties.`,
			);
		}

		// Convert to MCP format
		const mcpTool = aiSdkToolToMcp(
			{ name: toolName, tool: aiSdkTool },
			{ throwOnError: true },
		);

		// Store the loaded tool
		this.tools.set(toolName, {
			name: toolName,
			mcpTool,
			aiSdkTool,
		});

		console.log(
			`[AI SDK Loader] âœ“ Loaded tool '${toolName}' from ${config.path}`,
		);
	}

	/**
	 * Get all loaded MCP tools
	 */
	listTools(): McpTool[] {
		return Array.from(this.tools.values()).map((t) => t.mcpTool);
	}

	/**
	 * Execute an AI SDK tool by name
	 */
	async executeTool(
		name: string,
		args: Record<string, unknown>,
	): Promise<unknown> {
		const loadedTool = this.tools.get(name);

		if (!loadedTool) {
			throw new Error(`Tool '${name}' not found`);
		}

		console.log(`[AI SDK Loader] Executing tool: ${name}`);

		const result = await executeAiSdkTool(loadedTool.aiSdkTool, args);

		if (!result.success) {
			throw new Error(
				result.error?.message || `Tool execution failed: ${name}`,
			);
		}

		return result.result;
	}

	/**
	 * Check if a tool is loaded
	 */
	hasTool(name: string): boolean {
		return this.tools.has(name);
	}

	/**
	 * Get tool count
	 */
	getToolCount(): number {
		return this.tools.size;
	}

	/**
	 * Reload all tools (useful for development)
	 */
	async reload(configs: AiSdkToolConfig[]): Promise<void> {
		console.log("[AI SDK Loader] Reloading all tools...");
		this.tools.clear();
		await this.loadTools(configs);
	}
}
